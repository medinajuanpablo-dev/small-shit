<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mini RPG</title>
    <style>
      body {
        background: linear-gradient(135deg, #1a2a3a 0%, #2c3e50 100%);
        color: #ecf0f1;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        padding: 10px;
        min-height: 90vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .container {
        background: rgba(52, 73, 94, 0.9);
        padding: clamp(1rem, 3vw, 2rem);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        max-width: 800px;
        width: 95%;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
        margin: 1rem 0;
        padding: clamp(0.8rem, 2vw, 1rem);
        background: rgba(44, 62, 80, 0.7);
        border-radius: 15px;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
      }
      .battle-log {
        height: clamp(150px, 40vh, 200px);
        overflow-y: auto;
        background: rgba(44, 62, 80, 0.7);
        padding: clamp(0.8rem, 2vw, 1rem);
        border-radius: 15px;
        margin: 1rem 0;
        text-align: left;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .battle-log .message {
        margin: 0.3rem 0;
      }
      .battle-log .success {
        color: #2ecc71;
      }
      .battle-log .error {
        color: #e74c3c;
      }
      .battle-log .warning {
        color: #f1c40f;
      }
      .battle-log .info {
        color: #3498db;
      }
      button {
        padding: clamp(0.5rem, 2vw, 0.8rem) clamp(1rem, 4vw, 1.5rem);
        margin: 0.5rem;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        background: linear-gradient(145deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 300px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        background: linear-gradient(145deg, #2980b9, #3498db);
      }
      .monster {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        padding: clamp(0.8rem, 2vw, 1rem);
        margin: 0.5rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .level-up {
        background: linear-gradient(145deg, #2ecc71, #27ae60);
        padding: clamp(0.8rem, 2vw, 1rem);
        margin: 1rem 0;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .level-up.visible {
        visibility: visible;
        opacity: 1;
      }
      button:disabled {
        background: linear-gradient(145deg, #95a5a6, #7f8c8d);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .game-status {
        color: #2ecc71;
        font-size: clamp(1.2rem, 3vw, 1.5rem);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }
      .game-over {
        color: #e74c3c;
        font-size: clamp(1.2rem, 3vw, 1.5rem);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      @media (max-width: 400px) {
        .container {
          padding: 1rem;
          width: 100%;
          border-radius: 0;
        }
        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
        button {
          width: 100%;
          margin: 0.5rem 0;
        }
      }
    </style>
  </head>
  <body>
    <script type="module">
      import { h, setSignal } from 'https://unpkg.com/serajs';

      const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];

      const monsterTypes = [
        { name: 'Goblin', baseHp: 20, baseAtk: 5, baseDef: 2, sinceLevel: 1 },
        { name: 'Orco', baseHp: 30, baseAtk: 6, baseDef: 4, sinceLevel: 1 },
        { name: 'Troll', baseHp: 40, baseAtk: 9, baseDef: 2, sinceLevel: 2 },
        { name: 'Minotauro', baseHp: 50, baseAtk: 12, baseDef: 6, sinceLevel: 3 },
        { name: 'Dragón', baseHp: 70, baseAtk: 15, baseDef: 8, sinceLevel: 4 },
        { name: 'Lich', baseHp: 60, baseAtk: 18, baseDef: 5, sinceLevel: 5 },
      ];

      function Game() {
        const [hero, setHero] = setSignal({
          level: 1,
          hp: 100,
          maxHp: 100,
          atk: 10,
          def: 5,
          exp: 0,
          expToNext: 100,
          battlesLeft: 100,
          isDead: false,
        });

        const [currentDungeon, setCurrentDungeon] = setSignal(0);
        const [currentMonsters, setCurrentMonsters] = setSignal([]);
        const [battleLog, setBattleLog] = setSignal([]);
        const [showLevelUp, setShowLevelUpRaw] = setSignal(false);
        const [didEscape, setDidEscape] = setSignal(false);
        const [canAdvance, setCanAdvance] = setSignal(false);

        const setShowLevelUp = value => {
          const levelUpElement = document.getElementById('level-up');
          if (levelUpElement) {
            levelUpElement.className = `level-up ${value ? 'visible' : ''}`;
          }
          setShowLevelUpRaw(value);
        };

        const generateMonsters = () => {
          const numMonsters = Math.floor(Math.random() * 5) + 1;
          const monsters = [];
          const currentLevel = currentDungeon() + 1;

          for (let i = 0; i < numMonsters; i++) {
            const availableMonsters = monsterTypes.filter(type => type.sinceLevel <= currentLevel);
            const type = availableMonsters[Math.floor(Math.random() * availableMonsters.length)];
            const modifier = currentLevel;

            monsters.push({
              ...type,
              hp: Math.round(type.baseHp * modifier),
              maxHp: Math.round(type.baseHp * modifier),
              atk: Math.round(type.baseAtk * modifier),
              def: Math.round(type.baseDef * modifier),
            });
          }

          return monsters;
        };

        const checkAndHandleHeroDeath = () => {
          if (hero().hp > 0) return;
          setHero({ ...hero(), isDead: true });
          addToLog({
            message: '¡Héroe derrotado! Fin del juego.',
            className: 'error',
          });
          document.getElementById('game-status').className = 'game-over';
        };

        const healHero = () => {
          setHero({ ...hero(), hp: hero().maxHp });
          addToLog({
            message: '¡Héroe curado completamente!',
            className: 'success',
          });
        };

        const startBattle = () => {
          if (hero().isDead) return;

          if (hero().battlesLeft <= 0) {
            addToLog({
              message: '¡Se acabaron tus batallas! Fin del juego.',
              className: 'error',
            });
            return;
          }

          if (currentMonsters().length > 0) {
            addToLog({
              message: '¡Ya estás en una batalla!',
              className: 'warning',
            });
            return;
          }

          const newMonsters = generateMonsters();
          setCurrentMonsters(newMonsters);
          setDidEscape(false);
          addToLog({
            message: `¡Nueva batalla en la Mazmorra ${romanNumerals[currentDungeon()]}!`,
            className: 'info',
          });

          const monsterNames = newMonsters.map(m => m.name).join(', ');
          addToLog({
            message: `Te has encontrado con: ${monsterNames}`,
            className: 'info',
          });
        };

        const addToLog = message => {
          const logEntry = typeof message === 'string' ? { message, className: 'info' } : message;
          setBattleLog([...battleLog(), logEntry]);
        };

        const attack = () => {
          if (hero().isDead || currentMonsters().length === 0) return;

          const monster = currentMonsters()[0];
          const damage = Math.max(1, hero().atk - monster.def);
          monster.hp -= damage;
          addToLog(`Héroe ataca a ${monster.name} por ${damage} de daño (${monster.hp}/${monster.maxHp} HP)`);

          const monsterDamage = Math.max(1, monster.atk - hero().def);
          setHero({
            ...hero(),
            hp: Math.max(0, hero().hp - monsterDamage),
          });
          addToLog(`${monster.name} ataca al héroe por ${monsterDamage} de daño`);

          if (monster.hp <= 0) {
            const expGained = monster.maxHp * (currentDungeon() + 1);
            setHero({
              ...hero(),
              exp: hero().exp + expGained,
              battlesLeft: hero().battlesLeft - 1,
            });
            addToLog(`${monster.name} derrotado! +${expGained} EXP`);

            setCurrentMonsters(currentMonsters().filter(m => m !== monster));

            if (currentMonsters().length === 0) {
              endBattle();
            }
          }

          checkAndHandleHeroDeath();
        };

        const escape = () => {
          if (hero().isDead || currentMonsters().length === 0) return;

          const baseEscapeChance = 0.9; // 90% base
          const heroLevelBonus = hero().level * 0.1; // +10% por nivel
          const dungeonPenalty = currentDungeon() * 0.1; // -10% por nivel de mazmorra
          const monsterCountPenalty = currentMonsters().length * 0.1; // -10% por monstruo

          const escapeChance = Math.max(0.1, Math.min(0.9, baseEscapeChance + heroLevelBonus - dungeonPenalty - monsterCountPenalty));

          if (Math.random() < escapeChance) {
            addToLog(`¡Escape exitoso! (Probabilidad: ${Math.round(escapeChance * 100)}%)`);
            setCurrentMonsters([]);
            setDidEscape(true);
            endBattle();
          } else {
            addToLog(`¡Escape fallido! (Probabilidad: ${Math.round(escapeChance * 100)}%)`);
            const monster = currentMonsters()[0];
            const damage = Math.max(1, monster.atk - hero().def);
            setHero({
              ...hero(),
              hp: Math.max(0, hero().hp - damage),
            });
            addToLog(`${monster.name} ataca al héroe por ${damage} de daño`);

            checkAndHandleHeroDeath();
          }
        };

        const endBattle = () => {
          if (hero().exp >= hero().expToNext) {
            setShowLevelUp(true);
          } else if (currentDungeon() < 9 && !didEscape()) {
            if (!canAdvance()) addToLog('¡Puedes avanzar a la siguiente mazmorra!');
            setCanAdvance(true);
          }
        };

        const advanceDungeon = () => {
          if (!canAdvance() || currentDungeon() >= 9) {
            addToLog(`¡No puedes avanzar a la siguiente mazmorra aún! Debes ganar al menos 1 batalla`);
            return;
          }

          healHero();
          setCurrentDungeon(currentDungeon() + 1);
          setCanAdvance(false);
          addToLog(`¡Avanzaste a la Mazmorra ${romanNumerals[currentDungeon()]}!`);
        };

        const levelUp = stat => {
          const newHero = {
            ...hero(),
            level: hero().level + 1,
            exp: hero().exp - hero().expToNext,
            expToNext: Math.floor(hero().expToNext * 1.5),
          };

          switch (stat) {
            case 'hp':
              newHero.maxHp += 20;
              newHero.hp = newHero.maxHp;
              break;
            case 'atk':
              newHero.atk += 5;
              break;
            case 'def':
              newHero.def += 3;
              break;
          }

          setHero(newHero);
          setShowLevelUp(false);
          healHero();
          addToLog(`¡Subiste al nivel ${newHero.level}!`);
        };

        return h(
          'div',
          { className: 'container' },
          h('h1', null, 'Mini RPG'),
          h('h2', { id: 'game-status', className: 'game-status' }, () => (hero().isDead ? '¡Héroe derrotado! Fin del juego.' : 'En juego')),
          h('div', { className: 'stats' }, [
            h('div', null, () => `Nivel: ${hero().level}`),
            h('div', null, () => `HP: ${hero().hp}/${hero().maxHp}`),
            h('div', null, () => `ATK: ${hero().atk}`),
            h('div', null, () => `DEF: ${hero().def}`),
            h('div', null, () => `EXP: ${hero().exp}/${hero().expToNext}`),
            h('div', null, () => `Batallas: ${hero().battlesLeft}`),
          ]),
          h('div', { className: 'battle-log' }, () => {
            console.log(battleLog());
            return Array.from({ length: 10 }, (_, i) =>
              h(
                'div',
                {
                  key: i,
                  className: `message`,
                },
                () => battleLog()[battleLog().length - i - 1]?.message
              )
            );
          }),
          h('div', null, [
            h('button', { onclick: startBattle }, 'Iniciar Batalla'),
            h('button', { onclick: attack }, 'Atacar'),
            h('button', { onclick: escape }, 'Escapar'),
            h('button', { onclick: advanceDungeon }, 'Avanzar Mazmorra'),
          ]),
          h(
            'div',
            {
              id: 'level-up',
              className: 'level-up',
            },
            [
              h('h2', null, '¡Subiste de nivel!'),
              h('button', { onclick: () => levelUp('hp') }, 'Aumentar HP'),
              h('button', { onclick: () => levelUp('atk') }, 'Aumentar ATK'),
              h('button', { onclick: () => levelUp('def') }, 'Aumentar DEF'),
            ]
          )
        );
      }

      const root = document.body;
      root.appendChild(Game());
    </script>
  </body>
</html>
